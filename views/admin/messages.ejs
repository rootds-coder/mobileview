<div class="d-flex justify-content-between align-items-center mb-4">
    <h5 class="mb-0">
        <i class="fas fa-envelope me-2"></i>Contact Messages
    </h5>
    <div class="d-flex gap-2">
        <span class="badge bg-primary fs-6">
            <i class="fas fa-inbox me-1"></i><%= messages.length %> Total
        </span>
        <span class="badge bg-warning fs-6">
            <i class="fas fa-envelope me-1"></i><%= messages.filter(m => m.status === 'new').length %> New
        </span>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <% if (messages.length === 0) { %>
            <div class="text-center py-5">
                <i class="fas fa-envelope fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No messages found</h5>
                <p class="text-muted">Customer messages will appear here when they contact you.</p>
            </div>
        <% } else { %>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Status</th>
                            <th>Customer</th>
                            <th>Contact Info</th>
                            <th>Service</th>
                            <th>Message</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% messages.forEach(message => { %>
                            <tr class="<%= message.status === 'new' ? 'table-warning' : '' %>">
                                <td>
                                    <span class="badge bg-<%= message.status === 'new' ? 'warning' : (message.status === 'read' ? 'info' : 'success') %>">
                                        <%= message.status %>
                                    </span>
                                </td>
                                <td>
                                    <div class="fw-bold"><%= message.first_name %> <%= message.last_name %></div>
                                    <small class="text-muted"><%= message.email %></small>
                                </td>
                                <td>
                                    <div><%= message.phone %></div>
                                    <small class="text-muted"><%= message.device_type || 'Not specified' %></small>
                                </td>
                                <td>
                                    <span class="badge bg-secondary"><%= message.service_needed || 'General inquiry' %></span>
                                </td>
                                <td>
                                    <div class="text-truncate" style="max-width: 200px;" 
                                         title="<%= message.message %>">
                                        <%= message.message %>
                                    </div>
                                </td>
                                <td>
                                    <small class="text-muted">
                                        <%= new Date(message.created_at).toLocaleDateString() %>
                                    </small>
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-sm btn-outline-primary" 
                                                onclick="showMessageDetails(this)" 
                                                data-message='<%= JSON.stringify(message) %>'
                                                title="View message">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <% if (message.status === 'new') { %>
                                            <form method="POST" action="/sunny/messages/read/<%= message.id %>" 
                                                  style="display: inline;">
                                                <button type="submit" class="btn btn-sm btn-outline-info" 
                                                        title="Mark as read">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                            </form>
                                        <% } %>
                                        <form method="POST" action="/sunny/messages/delete/<%= message.id %>" 
                                              style="display: inline;" 
                                              onsubmit="return confirm('Are you sure you want to delete this message?')">
                                            <button type="submit" class="btn btn-sm btn-outline-danger" 
                                                    title="Delete message">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                        <% }); %>
                    </tbody>
                </table>
            </div>
        <% } %>
    </div>
</div>

<!-- Message Detail Modal -->
<div class="modal fade" id="messageModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-envelope me-2"></i>Message Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="messageModalBody">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-primary mb-3">Customer Information</h6>
                        <div class="mb-3">
                            <strong>Name:</strong> <span id="customerName"></span>
                        </div>
                        <div class="mb-3">
                            <strong>Email:</strong> <span id="customerEmail"></span>
                        </div>
                        <div class="mb-3">
                            <strong>Phone:</strong> <span id="customerPhone"></span>
                        </div>
                        <div class="mb-3">
                            <strong>Device:</strong> <span id="customerDevice"></span>
                        </div>
                        <div class="mb-3">
                            <strong>Service Needed:</strong> <span id="customerService"></span>
                        </div>
                        <div class="mb-3">
                            <strong>Date:</strong> <span id="messageDate"></span>
                        </div>
                        <div class="mb-3">
                            <strong>Status:</strong> <span id="messageStatus"></span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-primary mb-3">Message</h6>
                        <div class="border rounded p-3 bg-light" style="max-height: 300px; overflow-y: auto;">
                            <p id="messageContent" style="white-space: pre-wrap; margin-bottom: 0;"></p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" onclick="showEmailReplyForm()">
                    <i class="fas fa-envelope me-2"></i>Reply via Email
                </button>
                <button type="button" class="btn btn-success" onclick="replyViaWhatsApp()">
                    <i class="fab fa-whatsapp me-2"></i>Reply via WhatsApp
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Email Reply Modal -->
<div class="modal fade" id="emailReplyModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-reply me-2"></i>Reply via Email
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="emailReplyForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">To:</label>
                                <input type="email" class="form-control" id="replyTo" readonly>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Subject:</label>
                                <input type="text" class="form-control" id="replySubject" value="Re: Your inquiry about mobile repair">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">From:</label>
                                <input type="email" class="form-control" value="bgmi-india@bgmi-india.serv00.net" readonly>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Customer Name:</label>
                                <input type="text" class="form-control" id="replyCustomerName" readonly>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Message:</label>
                        <textarea class="form-control" id="replyMessage" rows="8" placeholder="Type your reply here..."></textarea>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="includeSignature" checked>
                            <label class="form-check-label" for="includeSignature">
                                Include professional signature
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="sendEmailReply()">
                    <i class="fas fa-paper-plane me-2"></i>Send Reply
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let currentMessage = null;

function showMessageDetails(button) {
    const messageData = JSON.parse(button.getAttribute('data-message'));
    currentMessage = messageData;
    
    // Populate modal with message data
    document.getElementById('customerName').textContent = messageData.first_name + ' ' + messageData.last_name;
    document.getElementById('customerEmail').textContent = messageData.email;
    document.getElementById('customerPhone').textContent = messageData.phone;
    document.getElementById('customerDevice').textContent = messageData.device_type || 'Not specified';
    document.getElementById('customerService').textContent = messageData.service_needed || 'General inquiry';
    document.getElementById('messageDate').textContent = new Date(messageData.created_at).toLocaleString();
    document.getElementById('messageStatus').textContent = messageData.status;
    document.getElementById('messageContent').textContent = messageData.message;
    
    // Mark as read if it's new
    if (messageData.status === 'new') {
        fetch(`/sunny/messages/read-api/${messageData.id}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        }).then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update the status badge in the table
                const statusBadge = button.closest('tr').querySelector('.badge');
                if (statusBadge) {
                    statusBadge.textContent = 'read';
                    statusBadge.className = 'badge bg-info';
                }
                // Update the current message status
                currentMessage.status = 'read';
                document.getElementById('messageStatus').textContent = 'read';
            }
        });
    }
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('messageModal'));
    modal.show();
}

function showEmailReplyForm() {
    if (!currentMessage) return;
    
    // Populate the email reply form
    document.getElementById('replyTo').value = currentMessage.email;
    document.getElementById('replyCustomerName').value = currentMessage.first_name + ' ' + currentMessage.last_name;
    document.getElementById('replySubject').value = 'Re: Your inquiry about ' + (currentMessage.service_needed || 'mobile repair');
    
    // Set default message
    const defaultMessage = `Dear ${currentMessage.first_name},\n\nThank you for contacting Mobile Doctor. We have received your inquiry about ${currentMessage.service_needed || 'mobile repair'}.\n\nWe will get back to you shortly with more details.\n\nBest regards,\nSunny Gujjar\nMobile Doctor\n+91 99929 19688`;
    document.getElementById('replyMessage').value = defaultMessage;
    
    // Close the message details modal and open email reply modal
    const messageModal = bootstrap.Modal.getInstance(document.getElementById('messageModal'));
    messageModal.hide();
    
    // Show email reply modal after a short delay
    setTimeout(() => {
        const emailModal = new bootstrap.Modal(document.getElementById('emailReplyModal'));
        emailModal.show();
    }, 300);
}

function sendEmailReply() {
    if (!currentMessage) return;
    
    const to = document.getElementById('replyTo').value;
    const subject = document.getElementById('replySubject').value;
    const message = document.getElementById('replyMessage').value;
    const includeSignature = document.getElementById('includeSignature').checked;
    
    if (!message.trim()) {
        alert('Please enter a message to send.');
        return;
    }
    
    // Show loading state
    const sendButton = document.querySelector('#emailReplyModal .btn-primary');
    const originalText = sendButton.innerHTML;
    sendButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Sending...';
    sendButton.disabled = true;
    
    // Prepare the email data
    const emailData = {
        to: to,
        subject: subject,
        message: message,
        customerName: currentMessage.first_name + ' ' + currentMessage.last_name,
        includeSignature: includeSignature
    };
    
    // Send the email via API
    fetch('/sunny/send-email-reply', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(emailData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Email sent successfully!');
            // Close the modal
            const emailModal = bootstrap.Modal.getInstance(document.getElementById('emailReplyModal'));
            emailModal.hide();
        } else {
            alert('Failed to send email: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error sending email:', error);
        alert('Failed to send email. Please try again.');
    })
    .finally(() => {
        // Reset button state
        sendButton.innerHTML = originalText;
        sendButton.disabled = false;
    });
}

function replyViaWhatsApp() {
    if (!currentMessage) return;
    
    const message = encodeURIComponent(`Hi ${currentMessage.first_name}! Thank you for contacting Mobile Doctor regarding ${currentMessage.service_needed || 'mobile repair'}. We have received your inquiry and will get back to you shortly. -Sunny Gujjar`);
    
    window.open(`https://wa.me/${currentMessage.phone.replace(/\D/g, '')}?text=${message}`, '_blank');
}
</script> 